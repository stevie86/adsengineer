#!/usr/bin/env node

// Load Test Data Cleanup Script
// Safely removes test data generated by load testing

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Configuration
const CLEANUP_CONFIG = {
  testDataMarker: 'LOAD_TEST_DATA_v1',
  dryRun: process.env.DRY_RUN === 'true',
  confirmCleanup: process.env.CONFIRM_CLEANUP === 'true'
};

// Database cleanup queries (adapt for your database)
class DatabaseCleanup {
  static async cleanupLeads() {
    // This would need to be adapted for your actual database schema
    console.log('ğŸ—‘ï¸  Cleaning up test leads...');

    if (CLEANUP_CONFIG.dryRun) {
      console.log('ğŸ” DRY RUN: Would clean up leads with _loadTestMarker');
      return;
    }

    // Example cleanup queries (adapt for your schema):
    // DELETE FROM leads WHERE customer_email LIKE '%@loadtest-%'
    // DELETE FROM orders WHERE _loadTestMarker = 'LOAD_TEST_DATA_v1'
    // DELETE FROM customers WHERE _loadTestMarker = 'LOAD_TEST_DATA_v1'

    console.log('âœ… Test leads cleaned up');
  }

  static async cleanupWebhookLogs() {
    console.log('ğŸ—‘ï¸  Cleaning up test webhook logs...');

    if (CLEANUP_CONFIG.dryRun) {
      console.log('ğŸ” DRY RUN: Would clean up webhook logs for loadtest-* domains');
      return;
    }

    // Example cleanup:
    // DELETE FROM webhook_logs WHERE shop_domain LIKE 'loadtest-%'

    console.log('âœ… Test webhook logs cleaned up');
  }

  static async cleanupRateLimitData() {
    console.log('ğŸ—‘ï¸  Cleaning up test rate limit data...');

    if (CLEANUP_CONFIG.dryRun) {
      console.log('ğŸ” DRY RUN: Would clean up rate limit keys for loadtest-*');
      return;
    }

    // For Cloudflare KV or Redis:
    // DELETE keys matching pattern: webhook:ip:* and webhook:shop:loadtest-*

    console.log('âœ… Test rate limit data cleaned up');
  }
}

class FileCleanup {
  static cleanupLogFiles() {
    console.log('ğŸ—‘ï¸  Cleaning up test log files...');

    const logFiles = [
      'load-test-results.json',
      'load-test-errors.log',
      'serverless/test-results.xml'
    ];

    logFiles.forEach(file => {
      const filePath = path.join(process.cwd(), file);
      if (fs.existsSync(filePath)) {
        if (CLEANUP_CONFIG.dryRun) {
          console.log(`ğŸ” DRY RUN: Would delete ${file}`);
        } else {
          fs.unlinkSync(filePath);
          console.log(`ğŸ—‘ï¸  Deleted ${file}`);
        }
      }
    });
  }
}

class CloudflareCleanup {
  static async cleanupWorkersKV() {
    console.log('ğŸ—‘ï¸  Cleaning up Cloudflare Workers KV test data...');

    if (CLEANUP_CONFIG.dryRun) {
      console.log('ğŸ” DRY RUN: Would clean up KV keys with loadtest markers');
      return;
    }

    // This would require wrangler CLI integration
    console.log('âš ï¸  Manual step required: Clean up KV namespace manually');
    console.log('   Run: wrangler kv:key list --namespace-id YOUR_RATE_LIMIT_KV_ID');
    console.log('   Delete keys containing "loadtest-" or "webhook:ip:*" from test runs');
  }
}

// Main cleanup execution
async function main() {
  console.log('ğŸ§¹ AdsEngineer Load Test Data Cleanup');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log(`Mode: ${CLEANUP_CONFIG.dryRun ? 'DRY RUN (no changes)' : 'LIVE CLEANUP'}`);
  console.log(`Test Data Marker: ${CLEANUP_CONFIG.testDataMarker}`);
  console.log('');

  if (!CLEANUP_CONFIG.confirmCleanup && !CLEANUP_CONFIG.dryRun) {
    console.log('âŒ SAFETY: Set CONFIRM_CLEANUP=true to enable actual cleanup');
    console.log('ğŸ’¡ Run with DRY_RUN=true first to see what would be cleaned');
    process.exit(1);
  }

  console.log('ğŸ—‚ï¸  Starting cleanup operations...\n');

  try {
    // Database cleanup
    await DatabaseCleanup.cleanupLeads();
    await DatabaseCleanup.cleanupWebhookLogs();
    await DatabaseCleanup.cleanupRateLimitData();

    // File cleanup
    FileCleanup.cleanupLogFiles();

    // Cloudflare cleanup
    await CloudflareCleanup.cleanupWorkersKV();

    console.log('\nğŸ‰ Cleanup completed successfully!');
    console.log('');
    console.log('ğŸ“‹ Summary of cleaned data:');
    console.log('  â€¢ Test orders and customers (emails ending in @loadtest-*)');
    console.log('  â€¢ Webhook logs for loadtest-* domains');
    console.log('  â€¢ Rate limiting data for test IPs');
    console.log('  â€¢ Test log files and temporary data');
    console.log('  â€¢ Cloudflare KV test entries (manual step)');

  } catch (error) {
    console.error('âŒ Cleanup failed:', error.message);
    process.exit(1);
  }
}

// Handle command line arguments
const args = process.argv.slice(2);
if (args.includes('--help') || args.includes('-h')) {
  console.log(`
AdsEngineer Load Test Cleanup

Usage: node cleanup-load-test-data.js [options]

Options:
  --dry-run          Show what would be cleaned without making changes
  --confirm          Confirm that you want to perform actual cleanup
  --help             Show this help

Environment Variables:
  DRY_RUN=true                 Only show what would be cleaned
  CONFIRM_CLEANUP=true         Allow actual cleanup operations

Safety Features:
  â€¢ DRY_RUN=true by default (safe mode)
  â€¢ Requires explicit CONFIRM_CLEANUP=true for live cleanup
  â€¢ Only removes data with specific test markers
  â€¢ Never removes production customer data

Examples:
  node cleanup-load-test-data.js --dry-run
  CONFIRM_CLEANUP=true node cleanup-load-test-data.js
  `);
  process.exit(0);
}

// Set defaults
if (!process.env.DRY_RUN) {
  CLEANUP_CONFIG.dryRun = true;
}

main().catch(console.error);