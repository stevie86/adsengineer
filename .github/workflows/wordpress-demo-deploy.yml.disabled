name: WordPress Demo Shop Auto-Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'woocommerce-plugin/**'
      - 'serverless/src/services/woocommerce-zip.ts'
      - 'serverless/src/routes/woocommerce.ts'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even without changes'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  WORDPRESS_DEMO_URL: ${{ secrets.WORDPRESS_DEMO_URL }}
  WORDPRESS_DEMO_ADMIN_USER: ${{ secrets.WORDPRESS_DEMO_ADMIN_USER }}
  WORDPRESS_DEMO_ADMIN_PASS: ${{ secrets.WORDPRESS_DEMO_ADMIN_PASS }}
  WORDPRESS_DEMO_SITE_ID: ${{ secrets.WORDPRESS_DEMO_SITE_ID }}
  WORDPRESS_DEMO_WEBHOOK_SECRET: ${{ secrets.WORDPRESS_DEMO_WEBHOOK_SECRET }}

jobs:
  deploy-plugin-to-demo:
    runs-on: ubuntu-latest
    name: Deploy Latest Plugin to Demo Shop
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check if plugin files changed
      id: changed
      run: |
        if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Check if plugin-related files changed
        git diff --name-only HEAD~1 HEAD | grep -E "(woocommerce-plugin|woocommerce-zip|woocommerce\.ts)" && echo "changed=true" >> $GITHUB_OUTPUT || echo "changed=false" >> $GITHUB_OUTPUT
        
    - name: Generate latest plugin ZIP
      if: steps.changed.outputs.changed == 'true'
      run: |
        echo "ðŸ”§ Generating latest WooCommerce plugin ZIP..."
        
        # Download the latest plugin from your API
        curl -s "https://adsengineer-cloud.adsengineer.workers.dev/api/v1/woocommerce/zip" \
          -o adsengineer-woocommerce-latest.zip
          
        # Verify ZIP is valid
        unzip -l adsengineer-woocommerce-latest.zip > /dev/null || exit 1
        
        echo "âœ… Plugin ZIP generated successfully"
        
    - name: Install WordPress CLI
      if: steps.changed.outputs.changed == 'true'
      run: |
        echo "ðŸ› ï¸ Installing WP-CLI..."
        curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
        chmod +x wp-cli.phar
        sudo mv wp-cli.phar /usr/local/bin/wp
        echo "âœ… WP-CLI installed"
        
    - name: Deploy plugin to demo shop
      if: steps.changed.outputs.changed == 'true'
      run: |
        echo "ðŸš€ Deploying plugin to demo WordPress site..."
        
        # Create WP-CLI config for remote site
        cat > wp-cli.yml << EOF
        ssh:
          user: ${{ secrets.WORDPRESS_DEMO_SSH_USER }}
          host: ${{ secrets.WORDPRESS_DEMO_SSH_HOST }}
          port: ${{ secrets.WORDPRESS_DEMO_SSH_PORT }}
        EOF
        
        # Backup current plugin if exists
        wp plugin is-installed adsengineer-woocommerce --ssh=${WORDPRESS_DEMO_SSH_USER}@${WORDPRESS_DEMO_SSH_HOST}:${WORDPRESS_DEMO_SSH_PORT} && \
          wp plugin deactivate adsengineer-woocommerce --ssh=${WORDPRESS_DEMO_SSH_USER}@${WORDPRESS_DEMO_SSH_HOST}:${WORDPRESS_DEMO_SSH_PORT} || true
        
        # Upload and install new plugin
        scp -P ${{ secrets.WORDPRESS_DEMO_SSH_PORT }} adsengineer-woocommerce-latest.zip ${{ secrets.WORDPRESS_DEMO_SSH_USER }}@${{ secrets.WORDPRESS_DEMO_SSH_HOST }}:/tmp/
        
        # Install plugin via WP-CLI
        wp plugin install /tmp/adsengineer-woocommerce-latest.zip --force --ssh=${WORDPRESS_DEMO_SSH_USER}@${WORDPRESS_DEMO_SSH_HOST}:${WORDPRESS_DEMO_SSH_PORT}
        
        # Activate plugin
        wp plugin activate adsengineer-woocommerce --ssh=${WORDPRESS_DEMO_SSH_USER}@${WORDPRESS_DEMO_SSH_HOST}:${WORDPRESS_DEMO_SSH_PORT}
        
        echo "âœ… Plugin deployed successfully"
        
    - name: Configure plugin settings
      if: steps.changed.outputs.changed == 'true'
      run: |
        echo "âš™ï¸ Configuring plugin settings..."
        
        # Set up plugin configuration
        wp option update adsengineer_site_id "${{ env.WORDPRESS_DEMO_SITE_ID }}" --ssh=${WORDPRESS_DEMO_SSH_USER}@${WORDPRESS_DEMO_SSH_HOST}:${WORDPRESS_DEMO_SSH_PORT}
        wp option update adsengineer_webhook_url "https://adsengineer-cloud.adsengineer.workers.dev/api/v1/woocommerce/webhook" --ssh=${WORDPRESS_DEMO_SSH_USER}@${WORDPRESS_DEMO_SSH_HOST}:${WORDPRESS_DEMO_SSH_PORT}
        wp option update adsengineer_webhook_secret "${{ env.WORDPRESS_DEMO_WEBHOOK_SECRET }}" --ssh=${WORDPRESS_DEMO_SSH_USER}@${WORDPRESS_DEMO_SSH_HOST}:${WORDPRESS_DEMO_SSH_PORT}
        
        echo "âœ… Plugin configured successfully"
        
    - name: Test plugin functionality
      if: steps.changed.outputs.changed == 'true'
      run: |
        echo "ðŸ§ª Testing plugin functionality..."
        
        # Verify plugin is active
        wp plugin is-active adsengineer-woocommerce --ssh=${WORDPRESS_DEMO_SSH_USER}@${WORDPRESS_DEMO_SSH_HOST}:${WORDPRESS_DEMO_SSH_PORT}
        
        # Check plugin settings
        echo "Plugin settings:"
        wp option get adsengineer_site_id --ssh=${WORDPRESS_DEMO_SSH_USER}@${WORDPRESS_DEMO_SSH_HOST}:${WORDPRESS_DEMO_SSH_PORT}
        wp option get adsengineer_webhook_url --ssh=${WORDPRESS_DEMO_SSH_USER}@${WORDPRESS_DEMO_SSH_HOST}:${WORDPRESS_DEMO_SSH_PORT}
        
        # Test that snippet is being injected
        curl -s "${{ env.WORDPRESS_DEMO_URL }}" | grep -q "adsengineer-cloud.adsengineer.workers.dev/snippet.js" && echo "âœ… Tracking snippet detected" || echo "âš ï¸ Tracking snippet not detected"
        
        echo "âœ… Plugin functionality verified"
        
    - name: Create test order
      if: steps.changed.outputs.changed == 'true'
      run: |
        echo "ðŸ›’ Creating test order to verify webhook integration..."
        
        # This would require WooCommerce CLI or API integration
        # For now, we'll just verify the webhook endpoint is accessible
        curl -s "${{ env.WORDPRESS_DEMO_URL }}/wp-json/wc/v3/orders" \
          -u "${{ secrets.WORDPRESS_DEMO_API_KEY }}" \
          -H "Content-Type: application/json" \
          -o /dev/null \
          -w "WooCommerce API Status: %{http_code}\n"
        
        echo "âœ… WooCommerce API accessible"
        
    - name: Upload deployment artifacts
      if: steps.changed.outputs.changed == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: wordpress-plugin-deployment
        path: |
          adsengineer-woocommerce-latest.zip
          deployment-logs.txt
        retention-days: 30
        
    - name: Notify deployment status
      if: steps.changed.outputs.changed == 'true'
      run: |
        echo "ðŸŽ‰ WordPress demo shop updated successfully!"
        echo "Demo URL: ${{ env.WORDPRESS_DEMO_URL }}"
        echo "Plugin version: Latest from main branch"
        echo "Deployment time: $(date)"
        
        # You could add Slack/Discord notification here
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ðŸš€ WordPress demo shop updated with latest WooCommerce plugin!"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}

  update-demo-status:
    runs-on: ubuntu-latest
    needs: deploy-plugin-to-demo
    if: always()
    name: Update Demo Status
    
    steps:
    - name: Create deployment status
      run: |
        if [ "${{ needs.deploy-plugin-to-demo.result }}" = "success" ]; then
          echo "âœ… Demo shop deployment completed successfully"
          echo "Status: Production-ready plugin deployed"
        else
          echo "âŒ Demo shop deployment failed"
          echo "Status: Manual intervention required"
        fi
        
        # You could update a status dashboard or database here
        # echo "Deployment status updated in monitoring system"