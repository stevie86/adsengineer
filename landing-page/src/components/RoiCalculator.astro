---
interface CalculatorProps {
  locale?: 'en' | 'de';
}

const translations = {
  en: {
    calculator: 'ROI Calculator',
    title: 'Is Google Seeing All Your Sales?',
    subtitle: 'Enter the numbers you already know. We\'ll show you what\'s going wrong.',
    monthlyAdBudget: 'Monthly Ad Spend',
    shopSales: 'Sales in your Shop',
    shopSalesHelp: 'How many orders did your shop actually process last month?',
    googleSales: 'Sales Google Ads Reports',
    googleSalesHelp: 'How many conversions does Google Ads show for the same period?',
    dontKnow: 'Not sure? Use industry average',
    resultTitle: 'Your Tracking Gap',
    missingSales: 'Missing Sales',
    lossPercent: 'Data Loss',
    wastedBudget: 'Wasted Ad Budget',
    yearlyWaste: 'Wasted per Year',
    withAdsEngineer: 'With AdsEngineer',
    recoveredSales: 'Recovered Sales',
    recoveredBudget: 'Budget Saved / Month',
    yourRoi: 'Your ROI',
    monthlyFee: 'Monthly Fee',
    netSavings: 'Net Savings / Month',
    yearlySavings: 'Net Savings / Year',
    salesPitchFix: 'Choose your setup: paste our script (like GTM) for instant results, or go full server-side for maximum performance. Both give you complete attribution and stop the budget waste.',
    ctaTitle: 'Stop Paying for Invisible Conversions',
    ctaDescription: 'Join the waitlist. We\'ll show you exactly where your data is leaking.',
    joinWaitlist: 'Join Waitlist',
    nameLabel: 'Name',
    emailLabel: 'Email',
    consentLabel: 'I agree to be contacted about AdsEngineer updates',
    placeholder: 'your@email.com',
    thanksForJoining: 'Thanks for joining!',
    wellSendYou: 'We\'ll email you when we launch.',
    benefit1: 'See every sale Google is missing',
    benefit2: 'Accurate data for smarter bidding',
    benefit3: 'GDPR compliant server-side tracking',
    ctaNote: 'No credit card required',
    shareCalcData: 'Share my calculator results to help improve the recommendation',
    shareCalcDataLabel: 'I agree to share my calculator inputs and results (ad spend, sales numbers, calculated waste) for analysis',
    recommendedPlan: 'Recommended for you',
    basedOnSpend: 'Based on your ad spend of',
    planStarter: 'Starter',
    planStarterDesc: '1 website · 10K events/mo · Server-side tracking · GDPR compliant',
    planGrowth: 'Growth',
    planGrowthDesc: 'Up to 5 websites · 100K events/mo · All integrations · Priority support',
    planEnterprise: 'Enterprise',
    planEnterpriseDesc: 'Unlimited websites · Custom events · SLA & dedicated support · Custom integrations',
    planMostPopular: 'Most Popular',
    perMonth: '/month',
    viewPricing: 'See all plans',
  },
  de: {
    calculator: 'ROI-Rechner',
    title: 'Sieht Google alle Ihre Verkäufe?',
    subtitle: 'Geben Sie die Zahlen ein, die Sie bereits kennen. Wir zeigen Ihnen, was schiefläuft.',
    monthlyAdBudget: 'Monatliche Werbeausgaben',
    shopSales: 'Verkäufe in Ihrem Shop',
    shopSalesHelp: 'Wie viele Bestellungen hat Ihr Shop letzten Monat tatsächlich verarbeitet?',
    googleSales: 'Verkäufe laut Google Ads',
    googleSalesHelp: 'Wie viele Conversions zeigt Google Ads für denselben Zeitraum?',
    dontKnow: 'Nicht sicher? Branchendurchschnitt verwenden',
    resultTitle: 'Ihre Tracking-Lücke',
    missingSales: 'Fehlende Verkäufe',
    lossPercent: 'Datenverlust',
    wastedBudget: 'Verschwendetes Budget',
    yearlyWaste: 'Verschwendet pro Jahr',
    withAdsEngineer: 'Mit AdsEngineer',
    recoveredSales: 'Zurückgewonnene Verkäufe',
    recoveredBudget: 'Budget gespart / Monat',
    yourRoi: 'Ihr ROI',
    monthlyFee: 'Monatliche Gebühr',
    netSavings: 'Netto-Ersparnis / Monat',
    yearlySavings: 'Netto-Ersparnis / Jahr',
    salesPitchFix: 'Wählen Sie Ihre Integration: Script einfügen (wie GTM) für sofortige Ergebnisse, oder volles Server-Side für maximale Performance. Beides gibt Ihnen vollständige Attribution und stoppt die Budget-Verschwendung.',
    ctaTitle: 'Hören Sie auf, für unsichtbare Conversions zu zahlen',
    ctaDescription: 'Warteliste beitreten. Wir zeigen Ihnen genau, wo Ihre Daten verloren gehen.',
    joinWaitlist: 'Warteliste beitreten',
    nameLabel: 'Name',
    emailLabel: 'E-Mail',
    consentLabel: 'Ich bin damit einverstanden, über AdsEngineer-Updates kontaktiert zu werden',
    placeholder: 'ihre@email.de',
    thanksForJoining: 'Danke für die Anmeldung!',
    wellSendYou: 'Wir senden Ihnen eine E-Mail, wenn wir starten.',
    benefit1: 'Jeden Verkauf sehen, den Google übersieht',
    benefit2: 'Genaue Daten für smarteres Bidding',
    benefit3: 'DSGVO-konformes Server-Side Tracking',
    ctaNote: 'Keine Kreditkarte erforderlich',
    shareCalcData: 'Meine Rechner-Ergebnisse zur Verbesserung der Empfehlung teilen',
    shareCalcDataLabel: 'Ich stimme zu, meine Rechner-Eingaben und Ergebnisse (Werbeausgaben, Verkaufszahlen, berechnete Verschwendung) für die Analyse zu teilen',
    recommendedPlan: 'Empfohlen für Sie',
    basedOnSpend: 'Basierend auf Ihren Werbeausgaben von',
    planStarter: 'Starter',
    planStarterDesc: '1 Website · 10K Events/Mo · Server-Side Tracking · DSGVO-konform',
    planGrowth: 'Growth',
    planGrowthDesc: 'Bis zu 5 Websites · 100K Events/Mo · Alle Integrationen · Prioritäts-Support',
    planEnterprise: 'Enterprise',
    planEnterpriseDesc: 'Unbegrenzte Websites · Individuelle Events · SLA & dedizierter Support · Individuelle Integrationen',
    planMostPopular: 'Beliebteste Wahl',
    perMonth: '/Monat',
    viewPricing: 'Alle Pakete ansehen',
  },
};

const { locale = 'en' } = Astro.props;
const t = translations[locale];
---

<div id="roi-calculator" class="py-20 bg-gradient-to-b from-gray-900/50 to-black/20 border-y border-white/5">
  <div class="container mx-auto px-6 max-w-7xl">
    <div class="text-center mb-12">
      <span class="text-cyan-400 font-bold tracking-widest uppercase text-sm">
        {t.calculator}
      </span>
      <h2 class="text-4xl font-bold mt-4 text-white">
        {t.title}
      </h2>
      <p class="text-gray-400 mt-4 max-w-2xl mx-auto text-lg">
        {t.subtitle}
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Left: Inputs + Results -->
      <div class="space-y-6">
        <!-- Input Card -->
        <div class="glass-card p-8 space-y-6">
          <!-- Monthly Ad Budget -->
          <div class="space-y-2">
            <label for="calc-budget" class="block text-sm font-medium text-gray-300">
              {t.monthlyAdBudget}
            </label>
            <div class="relative">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-lg pointer-events-none">€</span>
              <input
                type="number"
                id="calc-budget"
                min="500"
                max="500000"
                value="5000"
                step="500"
                class="w-full pl-10 pr-4 py-4 bg-gray-800/50 border border-gray-700 rounded-lg text-white text-xl font-bold focus:ring-2 focus:ring-purple-500 focus:border-transparent"
              />
            </div>
          </div>

          <!-- Shop Sales -->
          <div class="space-y-2">
            <label for="calc-shop-sales" class="block text-sm font-medium text-gray-300">
              {t.shopSales}
            </label>
            <p class="text-xs text-gray-500">{t.shopSalesHelp}</p>
            <input
              type="number"
              id="calc-shop-sales"
              min="1"
              max="100000"
              value="100"
              step="1"
              class="w-full px-4 py-4 bg-gray-800/50 border border-gray-700 rounded-lg text-white text-xl font-bold focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            />
          </div>

          <!-- Google Ads Sales -->
          <div class="space-y-2">
            <label for="calc-google-sales" class="block text-sm font-medium text-gray-300">
              {t.googleSales}
            </label>
            <p class="text-xs text-gray-500">{t.googleSalesHelp}</p>
            <input
              type="number"
              id="calc-google-sales"
              min="0"
              max="100000"
              value="62"
              step="1"
              class="w-full px-4 py-4 bg-gray-800/50 border border-gray-700 rounded-lg text-white text-xl font-bold focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            />
          </div>

          <!-- "Not sure" helper -->
          <button
            type="button"
            id="calc-use-average"
            class="text-sm text-purple-400 hover:text-purple-300 underline underline-offset-4 transition-colors"
          >
            {t.dontKnow}
          </button>
        </div>

        <!-- Results Card: The Gap -->
        <div id="calc-results" class="glass-card p-8 space-y-5">
          <h3 class="text-lg font-bold text-white flex items-center gap-2">
            <span class="text-red-400 text-xl">⚠</span>
            {t.resultTitle}
          </h3>

          <!-- Visual bar showing gap -->
          <div class="space-y-3">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-400">{t.shopSales}</span>
              <span id="calc-bar-shop" class="text-white font-bold">100</span>
            </div>
            <div class="w-full bg-gray-700/50 rounded-full h-5 overflow-hidden">
              <div id="calc-bar-shop-fill" class="h-full bg-gradient-to-r from-green-500 to-green-400 rounded-full transition-all duration-500" style="width: 100%"></div>
            </div>

            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-400">{t.googleSales}</span>
              <span id="calc-bar-google" class="text-cyan-400 font-bold">62</span>
            </div>
            <div class="w-full bg-gray-700/50 rounded-full h-5 overflow-hidden">
              <div id="calc-bar-google-fill" class="h-full bg-gradient-to-r from-cyan-500 to-cyan-400 rounded-full transition-all duration-500" style="width: 62%"></div>
            </div>
          </div>

          <!-- Key metrics -->
          <div class="grid grid-cols-3 gap-3 pt-2">
            <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-3 text-center">
              <p class="text-xs text-red-400 mb-1">{t.missingSales}</p>
              <p id="calc-missing" class="text-2xl font-bold text-red-500">38</p>
            </div>
            <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-3 text-center">
              <p class="text-xs text-red-400 mb-1">{t.lossPercent}</p>
              <p id="calc-loss-pct" class="text-2xl font-bold text-red-500">38%</p>
            </div>
            <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-3 text-center">
              <p class="text-xs text-red-400 mb-1">{t.wastedBudget}</p>
              <p id="calc-wasted" class="text-2xl font-bold text-red-500">€0</p>
            </div>
          </div>

          <div class="bg-red-500/5 border border-red-500/10 rounded-lg p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">{t.yearlyWaste}</p>
            <p id="calc-yearly-waste" class="text-3xl font-bold text-red-400">€0</p>
          </div>

          <!-- Divider -->
          <div class="relative py-2">
            <div class="h-px bg-gradient-to-r from-transparent via-green-500/50 to-transparent"></div>
            <span class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-[#0d1117] px-4 text-sm font-bold text-green-400 uppercase tracking-wider">{t.withAdsEngineer}</span>
          </div>

          <!-- Recovery metrics -->
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-3 text-center">
              <p class="text-xs text-green-400 mb-1">{t.recoveredSales}</p>
              <p id="calc-recovered" class="text-2xl font-bold text-green-500">+38</p>
            </div>
            <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-3 text-center">
              <p class="text-xs text-green-400 mb-1">{t.recoveredBudget}</p>
              <p id="calc-recovered-budget" class="text-2xl font-bold text-green-500">€0</p>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div class="bg-white/5 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-400 mb-1">{t.monthlyFee}</p>
              <p id="calc-fee" class="text-lg font-bold text-gray-300">€300</p>
            </div>
            <div class="bg-white/5 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-400 mb-1">{t.netSavings}</p>
              <p id="calc-net-monthly" class="text-lg font-bold text-green-400">€0</p>
            </div>
            <div class="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3 text-center">
              <p class="text-xs text-purple-400 mb-1">{t.yourRoi}</p>
              <p id="calc-roi" class="text-lg font-bold text-purple-400">0%</p>
            </div>
          </div>

          <div class="bg-green-500/5 border border-green-500/10 rounded-lg p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">{t.yearlySavings}</p>
            <p id="calc-yearly-savings" class="text-3xl font-bold text-green-400">€0</p>
          </div>
        </div>
      </div>

      <!-- Right Column: Pitch + Package Recommendation + Waitlist -->
      <div class="flex flex-col justify-between space-y-6 lg:sticky lg:top-8 lg:self-start">
        <!-- Dynamic Sales Pitch -->
        <div class="glass-card p-8 space-y-4">
          <p id="calc-pitch" class="text-gray-300 leading-relaxed text-lg"></p>
          <p class="text-cyan-400 leading-relaxed">
            {t.salesPitchFix}
          </p>
        </div>

        <!-- Package Recommendation Card -->
        <div id="calc-pkg-card" class="glass-card p-8 border-purple-500/30 shadow-[0_0_30px_rgba(188,19,254,0.15)] relative">
          <div id="calc-pkg-badge" class="absolute -top-3 left-1/2 -translate-x-1/2 bg-gradient-to-r from-purple-600 to-cyan-500 px-4 py-1 rounded-full text-xs font-bold text-white">
            {t.recommendedPlan}
          </div>

          <div class="text-center mt-2 mb-4">
            <p id="calc-pkg-reason" class="text-xs text-gray-500 mb-3"></p>
            <h3 id="calc-pkg-name" class="text-3xl font-bold text-white">Growth</h3>
          </div>

          <div class="text-center mb-4">
            <span id="calc-pkg-price" class="text-5xl font-black text-white">€149</span>
            <span class="text-gray-400">{t.perMonth}</span>
          </div>

          <p id="calc-pkg-desc" class="text-sm text-gray-400 text-center mb-4">{t.planGrowthDesc}</p>

          <!-- ROI comparison -->
          <div id="calc-pkg-roi-box" class="bg-green-500/10 border border-green-500/20 rounded-lg p-4 text-center mb-4">
            <p class="text-xs text-green-400 mb-1">{t.benefit1}</p>
            <p id="calc-pkg-roi-text" class="text-sm font-bold text-green-400"></p>
          </div>

          <a href="#pricing" class="block text-center text-sm text-purple-400 hover:text-purple-300 underline underline-offset-4 transition-colors">
            {t.viewPricing}
          </a>
        </div>

        <!-- Waitlist Form -->
        <div class="glass-card p-8">
          <h3 class="text-lg font-bold text-white mb-4 text-center">{t.ctaTitle}</h3>
          <form id="calculator-waitlist-form" class="space-y-4">
            <div id="calculator-form-error" class="hidden bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-lg text-sm"></div>
            <div id="calculator-form-success" class="hidden bg-green-500/10 border border-green-500/20 text-green-400 px-4 py-3 rounded-lg text-sm">
              {t.thanksForJoining}<br />{t.wellSendYou}
            </div>

            <!-- Hidden fields for calculator data -->
            <input type="hidden" id="calc-data-budget" name="calcBudget" value="" />
            <input type="hidden" id="calc-data-shop-sales" name="calcShopSales" value="" />
            <input type="hidden" id="calc-data-google-sales" name="calcGoogleSales" value="" />
            <input type="hidden" id="calc-data-blindness" name="calcBlindness" value="" />
            <input type="hidden" id="calc-data-wasted" name="calcWasted" value="" />
            <input type="hidden" id="calc-data-package" name="calcPackage" value="" />

            <div>
              <label for="calculator-name" class="block text-sm font-medium text-gray-300 mb-1">
                {t.nameLabel}
              </label>
              <input
                type="text"
                id="calculator-name"
                name="name"
                class="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder={t.nameLabel}
                required
              />
            </div>

            <div>
              <label for="calculator-email" class="block text-sm font-medium text-gray-300 mb-1">
                {t.emailLabel} <span class="text-red-400">*</span>
              </label>
              <input
                type="email"
                id="calculator-email"
                name="email"
                required
                class="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder={t.placeholder}
              />
            </div>

            <div class="flex items-start gap-3">
              <input
                type="checkbox"
                id="calculator-consent"
                name="consent"
                required
                class="mt-1 w-4 h-4 rounded border-gray-700 text-purple-500 focus:ring-purple-500 focus:ring-offset-0"
              />
              <label for="calculator-consent" class="text-sm text-gray-400">
                {t.consentLabel} <span class="text-red-400">*</span>
              </label>
            </div>

            <div class="flex items-start gap-3">
              <input
                type="checkbox"
                id="calculator-share-data"
                name="shareCalcData"
                class="mt-1 w-4 h-4 rounded border-gray-700 text-purple-500 focus:ring-purple-500 focus:ring-offset-0"
              />
              <label for="calculator-share-data" class="text-sm text-gray-400">
                <span class="text-cyan-400 font-medium">{t.shareCalcData}</span><br />
                <span class="text-gray-500 text-xs">{t.shareCalcDataLabel}</span>
              </label>
            </div>

            <div class="g-recaptcha flex justify-center" data-sitekey="6Lcds2ksAAAAAJOYwrlGqxYBqHdajZDuyWEF0sFT"></div>

            <button
              type="submit"
              class="w-full bg-gradient-to-r from-purple-600 to-cyan-500 hover:from-cyan-500 hover:to-purple-600 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300 shadow-lg"
            >
              {t.joinWaitlist}
            </button>

            <p class="text-gray-500 text-xs text-center">{t.ctaNote}</p>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  (function() {
    var LOCALE = document.documentElement.lang || 'en';

    var pitchTemplates = {
      en: 'Google only sees <strong class="text-red-400">{google}</strong> of your <strong class="text-white">{shop}</strong> sales. That means <strong class="text-red-400">{missing} sales are invisible</strong> — and <strong class="text-red-400">{wasted}</strong> of your ad budget is optimizing on blind data every month.',
      de: 'Google sieht nur <strong class="text-red-400">{google}</strong> Ihrer <strong class="text-white">{shop}</strong> Verkäufe. Das bedeutet <strong class="text-red-400">{missing} Verkäufe sind unsichtbar</strong> — und <strong class="text-red-400">{wasted}</strong> Ihres Werbebudgets optimiert auf blinden Daten jeden Monat.'
    };

    function fmt(value) {
      return new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(value);
    }

    function updateCalculator() {
      var budgetEl = document.getElementById('calc-budget');
      var shopEl = document.getElementById('calc-shop-sales');
      var googleEl = document.getElementById('calc-google-sales');
      if (!budgetEl || !shopEl || !googleEl) return;

      var budget = parseFloat(budgetEl.value) || 0;
      var shopSales = parseInt(shopEl.value) || 0;
      var googleSales = parseInt(googleEl.value) || 0;

      // Guard: google can't exceed shop
      if (googleSales > shopSales && shopSales > 0) {
        googleSales = shopSales;
        googleEl.value = googleSales;
      }

      // Calculate gap
      var missingSales = Math.max(0, shopSales - googleSales);
      var lossPct = shopSales > 0 ? (missingSales / shopSales) * 100 : 0;
      var wastedBudget = (budget * lossPct) / 100;
      var yearlyWaste = wastedBudget * 12;

      // AdsEngineer recovery (we recover ~95% of the gap)
      var recoveryRate = 0.95;
      var recoveredSales = Math.round(missingSales * recoveryRate);
      var recoveredBudget = wastedBudget * recoveryRate;

      // Fee: 20% of recovered waste, €300 min
      var fee = Math.max(recoveredBudget * 0.20, 300);
      var netMonthly = recoveredBudget - fee;
      var yearlySavings = netMonthly * 12;
      var roi = fee > 0 ? ((recoveredBudget / fee) - 1) * 100 : 0;

      // Update bars
      var barShopFill = document.getElementById('calc-bar-shop-fill');
      var barGoogleFill = document.getElementById('calc-bar-google-fill');
      var googlePct = shopSales > 0 ? (googleSales / shopSales) * 100 : 0;
      if (barShopFill) barShopFill.style.width = '100%';
      if (barGoogleFill) barGoogleFill.style.width = Math.max(googlePct, 2) + '%';

      // Update bar labels
      var barShop = document.getElementById('calc-bar-shop');
      var barGoogle = document.getElementById('calc-bar-google');
      if (barShop) barShop.textContent = shopSales;
      if (barGoogle) barGoogle.textContent = googleSales;

      // Update gap metrics
      document.getElementById('calc-missing').textContent = missingSales;
      document.getElementById('calc-loss-pct').textContent = Math.round(lossPct) + '%';
      document.getElementById('calc-wasted').textContent = fmt(wastedBudget);
      document.getElementById('calc-yearly-waste').textContent = fmt(yearlyWaste);

      // Update recovery metrics
      document.getElementById('calc-recovered').textContent = '+' + recoveredSales;
      document.getElementById('calc-recovered-budget').textContent = fmt(recoveredBudget);
      document.getElementById('calc-fee').textContent = fmt(fee);
      document.getElementById('calc-net-monthly').textContent = fmt(netMonthly);
      document.getElementById('calc-roi').textContent = Math.round(roi) + '%';
      document.getElementById('calc-yearly-savings').textContent = fmt(yearlySavings);

      // Update sales pitch
      var pitchEl = document.getElementById('calc-pitch');
      if (pitchEl) {
        var template = pitchTemplates[LOCALE] || pitchTemplates.en;
        pitchEl.innerHTML = template
          .replace('{google}', googleSales)
          .replace('{shop}', shopSales)
          .replace('{missing}', missingSales)
          .replace('{wasted}', fmt(wastedBudget));
      }

      // Package recommendation logic
      var pkgName, pkgPrice, pkgDesc, pkgReason;
      var planRoi = fee > 0 ? Math.round(((recoveredBudget / fee) - 1) * 100) : 0;
      
      if (budget < 3000) {
        pkgName = LOCALE === 'de' ? 'Starter' : 'Starter';
        pkgPrice = '€49';
        pkgDesc = LOCALE === 'de' 
          ? '1 Website · 10K Events/Mo · Server-Side Tracking · DSGVO-konform'
          : '1 website · 10K events/mo · Server-side tracking · GDPR compliant';
        pkgReason = LOCALE === 'de'
          ? 'Für Werbeausgaben bis €3.000/Monat'
          : 'For ad spend up to €3,000/month';
      } else if (budget < 20000) {
        pkgName = LOCALE === 'de' ? 'Growth' : 'Growth';
        pkgPrice = '€149';
        pkgDesc = LOCALE === 'de'
          ? 'Bis zu 5 Websites · 100K Events/Mo · Alle Integrationen · Prioritäts-Support'
          : 'Up to 5 websites · 100K events/mo · All integrations · Priority support';
        pkgReason = LOCALE === 'de'
          ? 'Für Werbeausgaben €3.000–€20.000/Monat'
          : 'For ad spend €3,000–€20,000/month';
      } else {
        pkgName = LOCALE === 'de' ? 'Enterprise' : 'Enterprise';
        pkgPrice = LOCALE === 'de' ? 'Individuell' : 'Custom';
        pkgDesc = LOCALE === 'de'
          ? 'Unbegrenzte Websites · Individuelle Events · SLA & dedizierter Support'
          : 'Unlimited websites · Custom events · SLA & dedicated support';
        pkgReason = LOCALE === 'de'
          ? 'Für Werbeausgaben über €20.000/Monat'
          : 'For ad spend over €20,000/month';
      }

      // Update package card
      var pkgNameEl = document.getElementById('calc-pkg-name');
      var pkgPriceEl = document.getElementById('calc-pkg-price');
      var pkgDescEl = document.getElementById('calc-pkg-desc');
      var pkgReasonEl = document.getElementById('calc-pkg-reason');
      var pkgRoiBox = document.getElementById('calc-pkg-roi-box');
      var pkgRoiText = document.getElementById('calc-pkg-roi-text');
      
      if (pkgNameEl) pkgNameEl.textContent = pkgName;
      if (pkgPriceEl) pkgPriceEl.textContent = pkgPrice;
      if (pkgDescEl) pkgDescEl.textContent = pkgDesc;
      if (pkgReasonEl) pkgReasonEl.textContent = pkgReason;
      
      if (pkgRoiText) {
        var feeStr = budget < 20000 ? (budget < 3000 ? '€49' : '€149') : 'Custom';
        pkgRoiText.innerHTML = feeStr + ' <span class="text-gray-400">→</span> ' + fmt(recoveredBudget) + ' <span class="text-gray-400">=</span> <span class="text-white">' + planRoi + '% ROI</span>';
      }

      // Update hidden fields for form submission
      var hiddenBudget = document.getElementById('calc-data-budget');
      var hiddenShopSales = document.getElementById('calc-data-shop-sales');
      var hiddenGoogleSales = document.getElementById('calc-data-google-sales');
      var hiddenBlindness = document.getElementById('calc-data-blindness');
      var hiddenWasted = document.getElementById('calc-data-wasted');
      var hiddenPackage = document.getElementById('calc-data-package');

      if (hiddenBudget) hiddenBudget.value = budget;
      if (hiddenShopSales) hiddenShopSales.value = shopSales;
      if (hiddenGoogleSales) hiddenGoogleSales.value = googleSales;
      if (hiddenBlindness) hiddenBlindness.value = Math.round(lossPct);
      if (hiddenWasted) hiddenWasted.value = Math.round(wastedBudget);
      if (hiddenPackage) hiddenPackage.value = pkgName;
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Attach input listeners
      var ids = ['calc-budget', 'calc-shop-sales', 'calc-google-sales'];
      for (var i = 0; i < ids.length; i++) {
        var el = document.getElementById(ids[i]);
        if (el) {
          el.addEventListener('input', updateCalculator);
        }
      }

      // "Use industry average" button
      var avgBtn = document.getElementById('calc-use-average');
      if (avgBtn) {
        avgBtn.addEventListener('click', function() {
          var shopEl = document.getElementById('calc-shop-sales');
          var googleEl = document.getElementById('calc-google-sales');
          var shopVal = parseInt(shopEl.value) || 100;
          // Industry average: ~38% loss
          googleEl.value = Math.round(shopVal * 0.62);
          updateCalculator();
        });
      }

      // Initial calculation
      updateCalculator();

      // Waitlist form handler
      var form = document.getElementById('calculator-waitlist-form');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();

          var name = document.getElementById('calculator-name').value;
          var email = document.getElementById('calculator-email').value;
          var consent = document.getElementById('calculator-consent').checked;
          var errorDiv = document.getElementById('calculator-form-error');
          var successDiv = document.getElementById('calculator-form-success');

          if (typeof grecaptcha === 'undefined') {
            errorDiv.textContent = LOCALE === 'de'
              ? 'reCAPTCHA nicht geladen. Bitte Seite neu laden.'
              : 'reCAPTCHA not loaded. Please refresh.';
            errorDiv.classList.remove('hidden');
            return;
          }

          var recaptchaResponse = grecaptcha.getResponse();
          if (!recaptchaResponse) {
            errorDiv.textContent = LOCALE === 'de'
              ? 'Bitte bestätigen Sie, dass Sie kein Roboter sind.'
              : 'Please verify that you are not a robot.';
            errorDiv.classList.remove('hidden');
            return;
          }

          errorDiv.classList.add('hidden');
          successDiv.classList.add('hidden');

          // Get calculator data if user consented
          var shareCalcData = document.getElementById('calculator-share-data').checked;
          var calcData = null;
          if (shareCalcData) {
            calcData = {
              adBudget: document.getElementById('calc-data-budget').value,
              shopSales: document.getElementById('calc-data-shop-sales').value,
              googleSales: document.getElementById('calc-data-google-sales').value,
              blindnessPercent: document.getElementById('calc-data-blindness').value,
              wastedBudget: document.getElementById('calc-data-wasted').value,
              recommendedPackage: document.getElementById('calc-data-package').value
            };
          }

          fetch('/api/waitlist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: name,
              email: email,
              locale: LOCALE,
              recaptchaToken: recaptchaResponse,
              consentToContact: consent,
              shareCalcData: shareCalcData,
              calculatorData: calcData
            })
          }).then(function(response) {
            return response.json().then(function(data) {
              if (response.ok && data.success) {
                successDiv.classList.remove('hidden');
                form.reset();
                grecaptcha.reset();
              } else {
                errorDiv.textContent = data.error || (LOCALE === 'de'
                  ? 'Anmeldung fehlgeschlagen. Bitte erneut versuchen.'
                  : 'Subscription failed. Please try again.');
                errorDiv.classList.remove('hidden');
                grecaptcha.reset();
              }
            });
          }).catch(function() {
            errorDiv.textContent = LOCALE === 'de'
              ? 'Anmeldung fehlgeschlagen. Bitte erneut versuchen.'
              : 'Subscription failed. Please try again.';
            errorDiv.classList.remove('hidden');
            grecaptcha.reset();
          });
        });
      }
    });
  })();
</script>

<style>
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    opacity: 1;
    height: 2rem;
  }
</style>