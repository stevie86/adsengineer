# AdsEngineer API Documentation

## Overview

AdsEngineer provides a REST API for lead management, conversion tracking, and GHL agency analytics. Built on Cloudflare Workers with D1 database for serverless scalability.

**Base URL:** `https://advocate-cloud.adsengineer.workers.dev`

## Authentication

### JWT Authentication (Primary)
Most API endpoints use JWT (JSON Web Token) authentication for session management.

#### Login Process
1. POST to `/api/v1/auth/login` with credentials
2. Receive JWT token in response
3. Include JWT in Authorization header for subsequent requests

#### Authentication Header
```
Authorization: Bearer YOUR_JWT_TOKEN_HERE
```

#### Example Login
```bash
curl -X POST "https://advocate-cloud.adsengineer.workers.dev/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password"}'
```

#### Example Authenticated Request
```bash
curl -X GET "https://advocate-cloud.adsengineer.workers.dev/api/v1/leads" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Public Endpoints
Some endpoints are public and don't require authentication:
- `GET /health` - Health check
- `GET /api/v1/billing/pricing` - Pricing information
- `POST /api/v1/waitlist` - Join waitlist
- `POST /api/v1/shopify/webhook` - Webhook receiver (uses HMAC)

### Authentication Errors
- `401 Unauthorized`: Missing or invalid API key
- `403 Forbidden`: Insufficient permissions

## API Endpoints

### Health Check
**GET** `/health`

Basic health check endpoint.

**Response:**
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T12:00:00Z",
  "version": "1.0.0"
}
```

---

### Leads

#### Create Lead
**POST** `/api/v1/leads`

Creates a new lead record in the database.

**Request Body:**
```json
{
  "agency_name": "ABC Marketing Agency",
  "website": "https://abcmarketing.com",
  "email": "contact@abcmarketing.com",
  "phone": "+1-555-0123",
  "lead_source": "hunter-army",
  "ghl_detected": true,
  "tracking_broken": true,
  "lead_value_cents": 50000,
  "notes": "Generated by Hunter Army AI pipeline"
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "lead": {
    "id": 123,
    "agency_name": "ABC Marketing Agency",
    "lead_score": 85,
    "status": "new",
    "created_at": "2024-01-01T12:00:00Z"
  }
}
```

**Validation Rules:**
- `agency_name`: Required, 1-255 characters
- `email`: Optional, valid email format
- `lead_value_cents`: Optional, positive integer
- `ghl_detected`: Boolean, defaults to false
- `tracking_broken`: Boolean, defaults to false

#### Get Leads
**GET** `/api/v1/leads`

Retrieves leads with optional filtering.

**Query Parameters:**
- `status`: Filter by status (new, contacted, qualified, closed)
- `lead_source`: Filter by source (hunter-army, manual, etc.)
- `limit`: Number of results (default: 50, max: 1000)
- `offset`: Pagination offset (default: 0)

**Example:**
```bash
curl -X GET "https://advocate-cloud.adsengineer.workers.dev/api/v1/leads?status=new&lead_source=hunter-army&limit=10" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

**Response:**
```json
{
  "success": true,
  "leads": [
    {
      "id": 123,
      "agency_name": "ABC Marketing",
      "email": "contact@abcmarketing.com",
      "lead_source": "hunter-army",
      "ghl_detected": true,
      "tracking_broken": true,
      "lead_score": 85,
      "status": "new",
      "created_at": "2024-01-01T12:00:00Z"
    }
  ],
  "total": 1,
  "limit": 10,
  "offset": 0
}
```

#### Get Single Lead
**GET** `/api/v1/leads/{id}`

Retrieves a specific lead by ID.

#### Update Lead
**PUT** `/api/v1/leads/{id}`

Updates an existing lead.

**Request Body:** Same as create, all fields optional.

#### Delete Lead
**DELETE** `/api/v1/leads/{id}`

Soft-deletes a lead (sets status to 'deleted').

---

### Agencies

#### List Agencies
**GET** `/api/v1/agencies`

Get paginated list of agencies discovered by Hunter Army.

#### Create Agency
**POST** `/api/v1/agencies`

Add a new agency record.

**Request Body:**
```json
{
  "name": "ABC Marketing Agency",
  "website": "https://abcmarketing.com",
  "location": "Austin, TX",
  "industry": "Marketing",
  "ghl_detected": true,
  "tracking_status": "broken"
}
```

---

### Analytics

#### Lead Analytics
**GET** `/api/v1/analytics/leads`

Get lead generation and conversion metrics.

**Response:**
```json
{
  "success": true,
  "analytics": {
    "total_leads": 150,
    "new_leads_today": 12,
    "qualified_leads": 45,
    "conversion_rate": 0.30,
    "avg_lead_value": 75000,
    "leads_by_source": {
      "hunter-army": 120,
      "manual": 30
    }
  }
}
```

#### Agency Analytics
**GET** `/api/v1/analytics/agencies`

Get agency discovery and analysis metrics.

---

### Webhooks

#### GHL Webhook
**POST** `/api/v1/ghl/webhook`

Webhook endpoint for GHL conversion events.

**Headers:**
- `X-GHL-Signature`: HMAC signature for verification

#### Waitlist Signup
**POST** `/api/v1/waitlist`

Handles waitlist form submissions.

---

## Rate Limits

- **Authenticated Requests**: 1000/hour per API key
- **Anonymous Requests**: 100/hour per IP
- **Webhook Requests**: Unlimited (but validated)

Rate limit headers in responses:
```
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 999
X-RateLimit-Reset: 1640995200
```

## Error Handling

All errors return JSON with consistent format:

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid email format",
    "field": "email"
  }
}
```

**Common Error Codes:**
- `VALIDATION_ERROR`: Input validation failed
- `AUTHENTICATION_ERROR`: Invalid API key
- `NOT_FOUND`: Resource not found
- `RATE_LIMITED`: Too many requests
- `INTERNAL_ERROR`: Server error

## SDKs & Examples

### JavaScript/Node.js
```javascript
const axios = require('axios');

const client = axios.create({
  baseURL: 'https://advocate-cloud.adsengineer.workers.dev',
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY',
    'Content-Type': 'application/json'
  }
});

// Create a lead
const lead = await client.post('/api/v1/leads', {
  agency_name: 'ABC Marketing',
  email: 'contact@abcmarketing.com',
  lead_source: 'hunter-army',
  ghl_detected: true,
  tracking_broken: true
});
```

### Python
```python
import requests

headers = {
    'Authorization': 'Bearer YOUR_API_KEY',
    'Content-Type': 'application/json'
}

# Create lead
lead_data = {
    'agency_name': 'ABC Marketing',
    'email': 'contact@abcmarketing.com',
    'lead_source': 'hunter-army'
}

response = requests.post(
    'https://advocate-cloud.adsengineer.workers.dev/api/v1/leads',
    json=lead_data,
    headers=headers
)
```

## Support

For API support:
- Check status: `GET /health`
- View docs: `GET /docs` (if OpenAPI enabled)
- Contact: support@adsengineer.workers.dev

## Changelog

- **v1.0.0**: Initial release with lead management
- **v1.1.0**: Added agency analytics
- **v1.2.0**: Enhanced webhook validation