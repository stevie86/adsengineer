---
wave: 3
depends_on:
  - 01-01-PLAN.md
files_modified:
  - serverless/src/routes/billing.ts
  - frontend/src/pages/Billing.tsx
  - frontend/src/components/PlanSelector.tsx
  - serverless/src/services/billing.ts
autonomous: true
---

# Plan 03: Billing Integration

**Objective:** Implement Stripe Checkout with 3-tier plans, webhook subscription activation, Customer Portal access, and fix race conditions with idempotency keys.

## must_haves

- [ ] User can complete Stripe Checkout for subscription
- [ ] 3-tier plan enforcement: $99/$299/$999
- [ ] Webhook activates subscription without race conditions
- [ ] User can access Customer Portal to manage billing

## Tasks

<task id="03-01">
  <description>Create Stripe Checkout session endpoint</description>
  <file>serverless/src/routes/billing.ts</file>
  <change>
    - POST /api/v1/billing/checkout-session
    - Accept plan_id (starter, professional, enterprise)
    - Validate user is authenticated
    - Create Stripe Checkout session with:
      - price_lookup_key from Stripe dashboard
      - success_url: /billing/success?session_id={CHECKOUT_SESSION_ID}
      - cancel_url: /billing/cancel
      - customer_email from JWT
      - client_reference_id: user_id (for webhook mapping)
    - Return { session_id, url }
  </change>
</task>

<task id="03-02">
  <description>Define Stripe price lookup keys</description>
  <file>serverless/src/config/billing.ts</file>
  <change>
    - export const PLAN_PRICES = {
        starter: 'price_starter_99',
        professional: 'price_professional_299', 
        enterprise: 'price_enterprise_999'
      }
    - These map to Stripe price IDs
  </change>
</task>

<task id="03-03">
  <description>Create frontend PlanSelector component</description>
  <file>frontend/src/components/PlanSelector.tsx</file>
  <change>
    - Display 3 plans: Starter ($99/mo), Professional ($299/mo), Enterprise ($999/mo)
    - Show feature comparison (use checkmarks for included features)
    - "Most Popular" badge on Professional
    - CTA button per plan triggers checkout
    - Loading state during API call
  </change>
</task>

<task id="03-04">
  <description>Create Billing page with plan selection</description>
  <file>frontend/src/pages/Billing.tsx</file>
  <change>
    - Display PlanSelector component
    - On plan select: call POST /api/v1/billing/checkout-session
    - Redirect to Stripe Checkout URL returned from API
    - Handle loading and error states
  </change>
</task>

<task id="03-05">
  <description>Create billing success page</description>
  <file>frontend/src/pages/BillingSuccess.tsx</file>
  <change>
    - Read session_id from URL query param
    - Call GET /api/v1/billing/session?session_id=xxx to verify
    - Show success message: "Subscription active!"
    - CTA to go to Dashboard
    - Handle case where webhook hasn't processed yet (show "Processing...")
  </change>
</task>

<task id="03-06">
  <description>Create billing cancel page</description>
  <file>frontend/src/pages/BillingCancel.tsx</file>
  <change>
    - Show "Checkout cancelled" message
    - Offer to try again or contact support
    - Link back to /billing
  </change>
</task>

<task id="03-07">
  <description>Implement Stripe webhook handler with idempotency</description>
  <file>serverless/src/routes/billing.ts</file>
  <change>
    - POST /api/v1/billing/webhook
    - Verify Stripe signature (webhook secret from Doppler)
    - Handle events:
      - checkout.session.completed: Activate subscription
      - invoice.payment_failed: Mark subscription past_due
      - customer.subscription.deleted: Cancel subscription
    - **CRITICAL: Use idempotency keys**
      - Check D1 for existing event_id before processing
      - Store event_id in processed_webhooks table
      - Skip if already processed (prevents race conditions)
    - Return 200 to Stripe (even if duplicate)
  </change>
</task>

<task id="03-08">
  <description>Create subscription activation service</description>
  <file>serverless/src/services/billing.ts</file>
  <change>
    - Function activateSubscription(user_id, stripe_subscription_id, plan_id)
    - Update users table: subscription_status='active', plan_id, stripe_subscription_id
    - Use D1 batch API for atomic update
    - Log activation in audit_logs
    - Send welcome email via Brevo
  </change>
</task>

<task id="03-09">
  <description>Create webhook processed check</description>
  <file>serverless/src/services/billing.ts</file>
  <change>
    - Function isEventProcessed(stripe_event_id): boolean
    - Query processed_webhooks table
    - Return true if event_id exists
  </change>
</task>

<task id="03-10">
  <description>Create processed webhooks table migration</description>
  <file>serverless/migrations/011_processed_webhooks.sql</file>
  <change>
    - CREATE TABLE processed_webhooks (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        stripe_event_id TEXT UNIQUE NOT NULL,
        processed_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    - Add index on stripe_event_id
  </change>
</task>

<task id="03-11">
  <description>Implement Customer Portal creation</description>
  <file>serverless/src/routes/billing.ts</file>
  <change>
    - POST /api/v1/billing/portal-session
    - Get user.stripe_customer_id from D1
    - Create Stripe Billing Portal session
    - Return { url } for customer to manage subscription
  </change>
</task>

<task id="03-12">
  <description>Add Customer Portal link to dashboard</description>
  <file>frontend/src/pages/Dashboard.tsx</file>
  <change>
    - Add "Manage Subscription" button
    - On click: call POST /api/v1/billing/portal-session
    - Redirect to returned URL
    - Only show if user has active subscription
  </change>
</task>

<task id="03-13">
  <description>Add subscription status to auth context</description>
  <file>frontend/src/context/AuthContext.tsx</file>
  <change>
    - Include subscription_status and plan_id in user object
    - Expose hasActiveSubscription() helper
    - Update on login and token refresh
  </change>
</task>

<task id="03-14">
  <description>Enforce plan limits</description>
  <file>serverless/src/middleware/subscription.ts</file>
  <change>
    - Create middleware checkPlanLimit(resource)
    - Check user's plan_id against limits:
      - Starter: 1 site, 1 platform
      - Professional: 5 sites, 3 platforms
      - Enterprise: unlimited
    - Return 403 if limit exceeded with upgrade message
  </change>
</task>

<task id="03-15">
  <description>Add plan checks to onboarding</description>
  <file>serverless/src/routes/onboarding.ts</file>
  <change>
    - Apply checkPlanLimit('sites') to POST /site-setup
    - Apply checkPlanLimit('platforms') to OAuth connections
  </change>
</task>

<task id="03-16">
  <description>Handle webhook race conditions in frontend</description>
  <file>frontend/src/pages/BillingSuccess.tsx</file>
  <change>
    - Poll GET /api/v1/user/me every 2 seconds for 30 seconds
    - Check if subscription_status === 'active'
    - Show "Processing..." while waiting
    - Show success once confirmed
    - Timeout with "Contact support if this persists"
  </change>
</task>

## Verification Criteria

- [ ] User can select plan → Stripe Checkout → pay → return → subscription active
- [ ] Webhook race condition test: Trigger 5 concurrent webhooks for same event, only 1 activates subscription
- [ ] Customer Portal opens and allows subscription management
- [ ] Plan limits enforced (try adding 2nd site on Starter plan → 403 error)
- [ ] Subscription status visible in dashboard
- [ ] Checkout cancellation shows appropriate message

## Dependencies

- Plan 01 (Auth Foundation) - Billing requires authenticated users

## Time Estimate

3-4 days
