---
wave: 1
depends_on: []
files_modified:
  - frontend/src/context/AuthContext.tsx
  - frontend/src/hooks/useAuth.ts
  - frontend/src/components/ProtectedRoute.tsx
  - serverless/src/routes/auth.ts
  - serverless/src/middleware/rateLimit.ts
autonomous: true
---

# Plan 01: Auth Foundation

**Objective:** Implement complete authentication system with email signup, Brevo double opt-in, JWT sessions, and protected routes.

## must_haves

- [ ] User can signup with email/password and receive verification email
- [ ] User can login and stay authenticated for 24+ hours
- [ ] Protected routes redirect unauthenticated users to login
- [ ] Auth endpoints have brute-force protection

## Tasks

<task id="01-01">
  <description>Create React AuthContext with JWT state management</description>
  <file>frontend/src/context/AuthContext.tsx</file>
  <change>
    - Create AuthContext with TypeScript
    - Store JWT token in localStorage (not httpOnly - Workers limitation)
    - Implement login, signup, logout, refresh methods
    - Expose useAuth() hook
    - Handle token expiry with proactive refresh at 23h
  </change>
</task>

<task id="01-02">
  <description>Create useAuth hook for components</description>
  <file>frontend/src/hooks/useAuth.ts</file>
  <change>
    - Wrapper hook that consumes AuthContext
    - Type-safe return: { user, login, signup, logout, isLoading, error }
  </change>
</task>

<task id="01-03">
  <description>Create ProtectedRoute component</description>
  <file>frontend/src/components/ProtectedRoute.tsx</file>
  <change>
    - React Router 7 wrapper component
    - Check auth state, redirect to /login if unauthenticated
    - Show loading spinner while checking
  </change>
</task>

<task id="01-04">
  <description>Setup axios interceptors for JWT</description>
  <file>frontend/src/lib/api.ts</file>
  <change>
    - Create axios instance with baseURL
    - Request interceptor: attach Authorization: Bearer <token>
    - Response interceptor: handle 401 by redirecting to login
    - Import and use in all API calls
  </change>
</task>

<task id="01-05">
  <description>Implement email/password signup endpoint</description>
  <file>serverless/src/routes/auth.ts</file>
  <change>
    - POST /api/v1/auth/signup
    - Validate email format, password strength (min 8 chars)
    - Hash password with bcrypt
    - Create user in D1 (users table)
    - Generate JWT with 24h expiry
    - Trigger Brevo DOI email via MCP
    - Return { token, user }
  </change>
</task>

<task id="01-06">
  <description>Implement email verification flow</description>
  <file>serverless/src/routes/auth.ts</file>
  <change>
    - POST /api/v1/auth/verify-email
    - Accept verification token from Brevo webhook
    - Update user.email_verified = true in D1
    - Return success message
  </change>
</task>

<task id="01-07">
  <description>Implement login endpoint</description>
  <file>serverless/src/routes/auth.ts</file>
  <change>
    - POST /api/v1/auth/login
    - Verify email/password against D1
    - Check email_verified flag
    - Generate JWT with 24h expiry
    - Return { token, user }
  </change>
</task>

<task id="01-08">
  <description>Implement token refresh endpoint</description>
  <file>serverless/src/routes/auth.ts</file>
  <change>
    - POST /api/v1/auth/refresh
    - Accept valid JWT (even if close to expiry)
    - Generate new JWT with fresh 24h expiry
    - Return { token }
  </change>
</task>

<task id="01-09">
  <description>Add rate limiting to auth endpoints</description>
  <file>serverless/src/middleware/rateLimit.ts</file>
  <change>
    - Create rate limiting middleware using Cloudflare Cache API
    - 5 attempts per IP per 15 minutes for login
    - 3 attempts per IP per hour for signup
    - Return 429 with Retry-After header
  </change>
</task>

<task id="01-10">
  <description>Wrap auth routes with rate limiting</description>
  <file>serverless/src/routes/auth.ts</file>
  <change>
    - Apply rateLimit middleware to POST /signup
    - Apply rateLimit middleware to POST /login
  </change>
</task>

<task id="01-11">
  <description>Update frontend routes with protection</description>
  <file>frontend/src/App.tsx</file>
  <change>
    - Wrap /dashboard, /onboarding, /billing with ProtectedRoute
    - Keep /login, /signup public
    - Add redirect from / to /dashboard (if auth) or /login (if not)
  </change>
</task>

<task id="01-12">
  <description>Wire up Signup page to AuthContext</description>
  <file>frontend/src/pages/Signup.tsx</file>
  <change>
    - Replace mock signup with useAuth().signup()
    - Show loading state during API call
    - Display error messages from API
    - On success, show "Check your email" message
  </change>
</task>

<task id="01-13">
  <description>Wire up Login page to AuthContext</description>
  <file>frontend/src/pages/Login.tsx</file>
  <change>
    - Replace mock login with useAuth().login()
    - Show loading state during API call
    - Display error messages from API
    - On success, redirect to /dashboard
  </change>
</task>

## Verification Criteria

- [ ] User can signup → receives Brevo verification email → verify → login
- [ ] JWT persists across page refreshes (localStorage)
- [ ] Protected routes redirect to /login when unauthenticated
- [ ] Rate limiting blocks brute-force attempts (test with 6+ rapid login attempts)
- [ ] Token refreshes proactively at 23h (not waiting for expiry)
- [ ] All auth endpoints return proper error messages

## Dependencies

None - this is Wave 1 (foundation).

## Time Estimate

2-3 days
