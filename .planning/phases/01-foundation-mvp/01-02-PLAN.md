---
wave: 2
depends_on:
  - 01-01-PLAN.md
files_modified:
  - serverless/src/routes/gdpr.ts
  - landing-page/src/components/hCaptcha.tsx
  - landing-page/src/pages/privacy-policy.astro
  - serverless/src/middleware/auditLog.ts
  - serverless/wrangler.toml
autonomous: true
---

# Plan 02: Security & GDPR Compliance

**Objective:** Secure GDPR endpoints with authentication, replace reCAPTCHA with hCaptcha, rewrite privacy policy, add audit logging, and lock Workers to EU region.

## must_haves

- [ ] GDPR endpoints require JWT authentication
- [ ] hCaptcha replaces reCAPTCHA on all forms
- [ ] Privacy policy is GDPR-compliant with Brevo disclosure
- [ ] Sensitive actions are audit logged
- [ ] Workers default to EU region

## Tasks

<task id="02-01">
  <description>Add JWT auth to GDPR endpoints</description>
  <file>serverless/src/routes/gdpr.ts</file>
  <change>
    - Import authMiddleware
    - Apply to ALL GDPR routes: GET /export, DELETE /delete, GET /status
    - Verify requesting user owns the email being queried
    - Return 401 if unauthenticated or unauthorized
  </change>
</task>

<task id="02-02">
  <description>Add ownership check to GDPR export</description>
  <file>serverless/src/routes/gdpr.ts</file>
  <change>
    - In GET /api/v1/gdpr/export
    - Extract user_id from JWT (c.get('auth').user_id)
    - Query D1 for user_id's data only
    - Never export other users' data
    - Return 403 if email param doesn't match authenticated user
  </change>
</task>

<task id="02-03">
  <description>Create hCaptcha React component</description>
  <file>landing-page/src/components/hCaptcha.tsx</file>
  <change>
    - Install @hcaptcha/react-hcaptcha
    - Create wrapper component with sitekey from Doppler
    - Props: onVerify(token), onExpire(), theme='light'
    - Use reaptcha-style but hCaptcha API
  </change>
</task>

<task id="02-04">
  <description>Add hCaptcha to landing page signup form</description>
  <file>landing-page/src/components/SignupForm.tsx</file>
  <change>
    - Add hCaptcha component above submit button
    - Store token in component state
    - Include token in POST to /api/v1/auth/signup
    - Reset captcha on error
  </change>
</task>

<task id="02-05">
  <description>Add hCaptcha to landing page waitlist form</description>
  <file>landing-page/src/components/WaitlistForm.tsx</file>
  <change>
    - Add hCaptcha component
    - Verify before submitting to Brevo
    - Include token in form submission
  </change>
</task>

<task id="02-06">
  <description>Add hCaptcha to landing page contact form</description>
  <file>landing-page/src/components/ContactForm.tsx</file>
  <change>
    - Add hCaptcha component
    - Verify before submitting
    - Include token in form submission
  </change>
</task>

<task id="02-07">
  <description>Implement hCaptcha server-side verification</description>
  <file>serverless/src/middleware/hCaptcha.ts</file>
  <change>
    - Create middleware function verifyHCaptcha(token: string)
    - POST to https://hcaptcha.com/siteverify
    - Send secret key (from Doppler) and token
    - Return { success: boolean, challenge_ts, hostname }
    - Throw error if success=false
  </change>
</task>

<task id="02-08">
  <description>Apply hCaptcha verification to auth endpoints</description>
  <file>serverless/src/routes/auth.ts</file>
  <change>
    - In POST /signup, verify hCaptcha token before processing
    - In POST /login, verify hCaptcha token
    - Return 400 { error: 'Invalid captcha' } if verification fails
  </change>
</task>

<task id="02-09">
  <description>Rewrite privacy policy for GDPR compliance</description>
  <file>landing-page/src/pages/privacy-policy.astro</file>
  <change>
    - Include: Data controller (AdsEngineer), Contact DPO
    - Include: Legal basis for processing (consent, contract, legal obligation)
    - Include: Brevo as email processor with DPA link
    - Include: Stripe as payment processor
    - Include: User rights (access, rectification, erasure, portability)
    - Include: Data retention periods (30 days post-cancellation)
    - Include: Cookie policy (necessary only, no tracking)
    - Include: EU data residency commitment
    - Include: How to exercise GDPR rights
  </change>
</task>

<task id="02-10">
  <description>Add ROI calculator disclaimers</description>
  <file>landing-page/src/components/ROICalculator.tsx</file>
  <change>
    - Add disclaimer text below results
    - "Results are estimates based on industry averages"
    - "Actual results may vary"
    - "Not financial advice"
  </change>
</task>

<task id="02-11">
  <description>Create audit logging middleware</description>
  <file>serverless/src/middleware/auditLog.ts</file>
  <change>
    - Create middleware that logs sensitive actions
    - Log: user_id, action, timestamp, ip, user_agent
    - Actions to log: login, logout, signup, password_change, gdpr_export, gdpr_delete, billing_update
    - Store in D1 (audit_logs table)
    - Use background execution (don't block response)
  </change>
</task>

<task id="02-12">
  <description>Apply audit logging to sensitive routes</description>
  <file>serverless/src/routes/auth.ts</file>
  <change>
    - Add auditLog middleware to POST /login, POST /logout, POST /signup
  </change>
</task>

<task id="02-13">
  <description>Add audit logging to GDPR routes</description>
  <file>serverless/src/routes/gdpr.ts</file>
  <change>
    - Add auditLog middleware to GET /export, DELETE /delete
  </change>
</task>

<task id="02-14">
  <description>Add audit logging to billing routes</description>
  <file>serverless/src/routes/billing.ts</file>
  <change>
    - Add auditLog middleware to subscription changes
  </change>
</task>

<task id="02-15">
  <description>Lock Cloudflare Workers to EU region</description>
  <file>serverless/wrangler.toml</file>
  <change>
    - Add [env.production]
    - routes = { pattern = "...", zone_name = "..." }
    - Add routes = { ..., jurisdiction = "eu" }
    - Ensure EU data residency by default
  </change>
</task>

<task id="02-16">
  <description>Add per-customer region override (optional)</description>
  <file>serverless/src/config/region.ts</file>
  <change>
    - Create region configuration module
    - Default: 'eu'
    - Allow override via org.region setting in D1
    - Export getRegion(org_id) function
  </change>
</task>

<task id="02-17">
  <description>Remove old reCAPTCHA code</description>
  <file>landing-page/src/components/</file>
  <change>
    - Find and remove all reCAPTCHA imports
    - Remove reCAPTCHA site keys from config
    - Update forms that used reCAPTCHA to use hCaptcha
  </change>
</task>

## Verification Criteria

- [ ] GDPR export endpoint returns 401 without JWT
- [ ] GDPR export only returns data for authenticated user (test with user A's token requesting user B's data)
- [ ] hCaptcha appears on all landing page forms (waitlist, signup, contact)
- [ ] hCaptcha verification blocks bots (test with invalid token)
- [ ] Privacy policy includes all GDPR-required sections
- [ ] Audit logs are written to D1 for login/signup/GDPR/billing actions
- [ ] Workers are configured for EU jurisdiction

## Dependencies

- Plan 01 (Auth Foundation) must be complete - GDPR endpoints need JWT auth

## Time Estimate

2-3 days
