---
wave: 4
depends_on:
  - 01-01-PLAN.md
  - 01-03-PLAN.md
files_modified:
  - frontend/src/pages/Dashboard.tsx
  - frontend/src/components/ConversionTable.tsx
  - frontend/src/components/SyncStatus.tsx
  - frontend/src/components/SampleDataPreview.tsx
  - serverless/src/routes/analytics.ts
autonomous: true
---

# Plan 04: Dashboard Real Data

**Objective:** Replace hardcoded test IDs with live authentication, display real conversion data, sync status, and implement sample data preview for empty states.

## must_haves

- [ ] Dashboard shows real data filtered by authenticated org_id
- [ ] No hardcoded test-agency-id in codebase
- [ ] Live conversion count and table
- [ ] Sync status with manual refresh
- [ ] Sample data preview when no conversions exist

## Tasks

<task id="04-01">
  <description>Kill hardcoded test-agency-id in Dashboard</description>
  <file>frontend/src/pages/Dashboard.tsx</file>
  <change>
    - Find and remove all instances of 'test-agency-id' or hardcoded IDs
    - Replace with dynamic org_id from useAuth() context
    - Ensure all API calls use authenticated user's org_id
  </change>
</task>

<task id="04-02">
  <description>Create useDashboardData hook</description>
  <file>frontend/src/hooks/useDashboardData.ts</file>
  <change>
    - Fetch dashboard data from /api/v1/analytics/dashboard
    - Include: conversion_count, recent_conversions[], sync_status
    - Auto-refresh every 30 seconds
    - Loading and error states
    - Return { data, isLoading, error, refetch }
  </change>
</task>

<task id="04-03">
  <description>Implement analytics dashboard endpoint</description>
  <file>serverless/src/routes/analytics.ts</file>
  <change>
    - GET /api/v1/analytics/dashboard
    - Extract org_id from JWT (c.get('auth').org_id)
    - Query D1 for:
      - COUNT(*) as conversion_count (filtered by org_id)
      - Latest 10 conversions (platform, timestamp, value, order_id)
      - Last sync timestamp from sync_logs table
    - Return { conversion_count, conversions[], last_sync_at, sync_status }
  </change>
</task>

<task id="04-04">
  <description>Create ConversionTable component</description>
  <file>frontend/src/components/ConversionTable.tsx</file>
  <change>
    - Compact 3-column layout: Platform (icon), Timestamp, Value
    - Props: conversions[]
    - Format timestamps (relative: "2 hours ago", absolute on hover)
    - Format values as currency ($1,234.56)
    - Platform icons: Google Ads, Meta, TikTok, Shopify, WooCommerce
    - Empty state: show SampleDataPreview component
  </change>
</task>

<task id="04-05">
  <description>Create SyncStatus component</description>
  <file>frontend/src/components/SyncStatus.tsx</file>
  <change>
    - Props: last_sync_at, status, onSync()
    - Display status badge:
      - Green: synced < 1 hour ago
      - Yellow: synced 1-24 hours ago
      - Red: synced > 24 hours ago or error
    - Show last sync time (relative: "Synced 2 hours ago")
    - "Sync Now" button calls onSync prop
    - Loading state during sync
  </change>
</task>

<task id="04-06">
  <description>Create SampleDataPreview component</description>
  <file>frontend/src/components/SampleDataPreview.tsx</file>
  <change>
    - Display sample conversion data (hardcoded examples)
    - Show 3-4 sample rows with realistic data
    - Overlay text: "This is what you'll see after your first conversion"
    - CTA button: "Install tracking snippet" → links to /onboarding/snippet
    - Semi-transparent styling to indicate "preview" mode
  </change>
</task>

<task id="04-07">
  <description>Create single stat hero component</description>
  <file>frontend/src/components/ConversionCount.tsx</file>
  <change>
    - Large number display: "1,234" (conversion count)
    - Label: "Conversions this month" (or selected period)
    - Trend indicator: +12% vs last month (if we have historical data)
    - Clean, minimal design
  </change>
</task>

<task id="04-08">
  <description>Redesign Dashboard page layout</description>
  <file>frontend/src/pages/Dashboard.tsx</file>
  <change>
    - Single stat hero at top (ConversionCount)
    - SyncStatus bar below (badge + time + sync button)
    - ConversionTable below that
    - Loading state: skeleton screens
    - Error state: error message with retry button
    - Empty state: SampleDataPreview with CTA
  </change>
</task>

<task id="04-09">
  <description>Implement manual sync endpoint</description>
  <file>serverless/src/routes/analytics.ts</file>
  <change>
    - POST /api/v1/analytics/sync
    - Trigger sync job (queue or immediate based on volume)
    - Update sync_logs table
    - Return { status: 'syncing', estimated_completion }
  </change>
</task>

<task id="04-10">
  <description>Wire Sync Now button to API</description>
  <file>frontend/src/components/SyncStatus.tsx</file>
  <change>
    - On click: call POST /api/v1/analytics/sync
    - Show loading spinner
    - Poll for sync completion
    - Refresh dashboard data when complete
  </change>
</task>

<task id="04-11">
  <description>Ensure all analytics endpoints filter by org_id</description>
  <file>serverless/src/routes/analytics.ts</file>
  <change>
    - Review ALL endpoints in this file
    - Ensure every query filters by org_id from JWT
    - Never return data for other organizations
    - Add test: request with user A's token should not see user B's data
  </change>
</task>

<task id="04-12">
  <description>Add dashboard error boundaries</description>
  <file>frontend/src/pages/Dashboard.tsx</file>
  <change>
    - Wrap dashboard in ErrorBoundary
    - Show friendly error message if API fails
    - Include "Try again" button
    - Log errors to monitoring
  </change>
</task>

<task id="04-13">
  <description>Optimize dashboard loading states</description>
  <file>frontend/src/pages/Dashboard.tsx</file>
  <change>
    - Show skeleton screens while loading (not spinner)
    - Skeleton for stat hero
    - Skeleton for sync status
    - Skeleton rows for table
  </change>
</task>

## Verification Criteria

- [ ] Search codebase for 'test-agency-id' → 0 results
- [ ] Dashboard displays real conversion count from API
- [ ] Conversion table shows data filtered by authenticated org_id (test with 2 users)
- [ ] Sync status shows correct last sync time
- [ ] Manual sync button triggers sync and updates data
- [ ] Empty state shows sample data preview with CTA
- [ ] Loading states use skeleton screens (not spinners)
- [ ] Error states are handled gracefully

## Dependencies

- Plan 01 (Auth Foundation) - Need JWT context for org_id
- Plan 03 (Billing) - Optional: show subscription status in dashboard

## Time Estimate

2-3 days
